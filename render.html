<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Submission Details</title>
  <style>
    body { background:#181818; color:#f0f0f0; font-family:Consolas,'Courier New',monospace; margin:0; }
    .wrap { max-width:860px; margin:40px auto; padding:0 16px; }
    .panel { background:#222; border:1px solid #444; border-radius:8px; padding:22px 20px; margin-bottom:18px; }
    h1 { margin:0 0 10px; font-size:1.6rem; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .meta-grid { display:grid; grid-template-columns: repeat(2,minmax(180px,1fr)); gap:10px 18px; margin-top:8px; }
    .key { color:#bdbdbd; }
    .value { color:#fff; font-weight:700; }
    .btn {
      background:#282828; color:#f0f0f0; border:1px solid #444; border-radius:4px;
      padding:8px 16px; font-weight:700; cursor:pointer; transition:background .15s;
    }
    .btn:hover { background:#333; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .cases-table { width:100%; border-collapse:collapse; margin-top:12px; }
    .cases-table th, .cases-table td { border:1px solid #34343a; padding:10px 12px; text-align:left; font-size:0.96rem; }
    .cases-table th { background:#26262b; letter-spacing:.5px; }
    .cases-table tr:nth-child(even) { background:#202024; }
    .case-status-ok { color:#8adf8a; font-weight:700; }
    .case-status-fail { color:#ff8a80; font-weight:700; }
    #statusText { white-space: pre-line; }
    .field { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="password"] {
      background:#111; color:#fafafa; border:1px solid #444; border-radius:6px; padding:10px 12px;
      font-family:inherit; font-size:1rem; min-width:220px;
    }
    pre.codebox {
      background:#111; border:1px solid #333; border-radius:6px; padding:14px;
      overflow:auto; max-height:60vh; margin-top:12px; font-size:.95rem;
    }
    .muted { color:#bdbdbd; }
  </style>

  <!-- Optional: highlight.js for nicer code display -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/xt256.min.css">
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Header / Meta -->
    <div class="panel">
      <div class="row">
        <h1>Submission Details</h1>
        <div>
          <button id="refreshBtn" class="btn">Refresh</button>
          <button class="btn" onclick="history.back()">← Back</button>
        </div>
      </div>
      <div class="meta-grid" id="metaGrid">
        <div><span class="key">Submission ID:</span> <span class="value" id="metaSid">—</span></div>
        <div><span class="key">Status:</span> <span class="value" id="metaStatus">—</span></div>
        <div><span class="key">Passed:</span> <span class="value" id="metaPassed">—</span></div>
        <div><span class="key">Total Cases:</span> <span class="value" id="metaCases">—</span></div>
      </div>
    </div>

    <!-- Cases -->
    <div class="panel" id="statusPanel">
      <p id="statusText">Loading…</p>
      <div id="casesContainer"></div>
    </div>

    <!-- Source Code (password-gated) -->
    <div class="panel" id="codePanel">
      <div class="row" style="margin-bottom:8px;">
        <h2 style="margin:0;font-size:1.25rem;">Source Code</h2>
        <div class="field">
          <input id="codePassword" type="password" placeholder="enter admin password"/>
          <button id="showCodeBtn" class="btn">Show Code</button>
          <button id="copyCodeBtn" class="btn" disabled>Copy</button>
        </div>
      </div>
      <p id="codeStatus" class="muted">Code is hidden. Enter the password to view.</p>
      <pre id="codePre" class="codebox" style="display:none;"><code id="codeBlock"></code></pre>
    </div>
  </div>

<script>
/* ---------- Config ---------- */
const URL = "https://diphycercal-aurore-introrsely.ngrok-free.dev";

/* ---------- Utils ---------- */
function getSidFromQuery(){
  const p = new URLSearchParams(location.search);
  return p.get('submissionID');
}
async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function formatTime(ns){ return (typeof ns==='number'&&Number.isFinite(ns))?(ns/1e6).toFixed(2)+' ms':'—'; }
function formatMemory(b){ return (typeof b==='number'&&Number.isFinite(b))?(b/1024).toFixed(0)+' KB':'—'; }

/* ---------- DOM ---------- */
const statusPanel = document.getElementById('statusPanel');
const statusText  = document.getElementById('statusText');
const casesContainer = document.getElementById('casesContainer');
const refreshBtn = document.getElementById('refreshBtn');

/* Code panel DOM */
const codePanel   = document.getElementById('codePanel');
const codeStatus  = document.getElementById('codeStatus');
const codePre     = document.getElementById('codePre');
const codeBlock   = document.getElementById('codeBlock');
const codePwd     = document.getElementById('codePassword');
const showCodeBtn = document.getElementById('showCodeBtn');
const copyCodeBtn = document.getElementById('copyCodeBtn');

/* ---------- Render cases ---------- */
function renderCases(cases){
  if(!Array.isArray(cases)||cases.length===0){ casesContainer.innerHTML='<p>No cases available.</p>'; return; }
  const rows=cases.map((t,i)=>{
    const s=t.ok?'case-status-ok':'case-status-fail';
    const msg=(t.msg||'').replace(/\n/g,'<br />');
    return `<tr><td>Case ${i+1}</td><td class="${s}">${t.status||(t.ok?'Accepted':'Failed')}</td><td>${formatTime(t.time)}</td><td>${formatMemory(t.memory)}</td><td>${msg}</td></tr>`;
  }).join('');
  casesContainer.innerHTML=`<table class="cases-table"><thead><tr><th>Case</th><th>Status</th><th>Time</th><th>Memory</th><th>Message</th></tr></thead><tbody>${rows}</tbody></table>`;

  for (let idx=0; idx<cases.length; idx++) {
    const test = cases[idx];
    let msg = (test.msg || '');
    const row = casesContainer.querySelector(`tbody tr:nth-child(${idx + 1})`);
    if (idx === 0) {
      casesContainer._scoreTotal = 0;
      casesContainer._anyFail = false;
      const prev = document.getElementById('totalScoreBadge');
      if (prev) prev.remove();
    }
    //if (!test.ok) casesContainer._anyFail = true;

    const match = msg.match(/-?\d[\d,]*(?:\.\d+)?/);
    if (match && test.ok) {
      const value = Number(match[0].replace(/,/g, ''));
      test.extractedNumber = value;
      casesContainer._scoreTotal = (casesContainer._scoreTotal || 0) + value;

      if (row) {
        const cell = row.cells[4];
        if (cell) {
          const badge = document.createElement('span');
          badge.style.marginLeft = '10px';
          badge.style.color = '#9ee6ff';
          badge.style.fontWeight = '700';
          badge.textContent = `Extracted: ${value}`;
          cell.appendChild(badge);
        }
      }
    }
    if (idx === cases.length - 1) {
      const finalScore = casesContainer._anyFail ? 0 : (casesContainer._scoreTotal || 0);
      const totalEl = document.createElement('div');
      totalEl.id = 'totalScoreBadge';
      totalEl.style.marginTop = '12px';
      totalEl.style.padding = '10px 14px';
      totalEl.style.background = '#0b2a2f';
      totalEl.style.color = '#9ee6ff';
      totalEl.style.fontWeight = '700';
      totalEl.style.border = '1px solid #07494f';
      totalEl.style.display = 'inline-block';
      totalEl.textContent = `Total Score: ${finalScore}`;
      statusPanel.prepend(totalEl);
    }
  }
}

/* ---------- Poll for result ---------- */
async function pollForResult(sid){
  let attempt=0;
  while(true){
    attempt++;
    try{
      const r=await fetch(`${URL}/result/${encodeURIComponent(sid)}`,{headers:{'ngrok-skip-browser-warning':'true'}});
      if(!r.ok) throw new Error('Result request failed');
      const payload=await r.json();
      if(payload&&payload.status==='done') return payload;
      if(payload&&payload.status==='error') { statusText.textContent=payload['error']; return; }
      statusText.textContent=`In queue (attempt ${attempt})...`;
    }catch(e){ console.error(e); statusText.textContent='Judging...'; }
    await sleep(1000);
  }
}

/* ---------- Meta ---------- */
function renderMeta(sid, resultPayload){
  const metaSid    = document.getElementById('metaSid');
  const metaStatus = document.getElementById('metaStatus');
  const metaPassed = document.getElementById('metaPassed');
  const metaCases  = document.getElementById('metaCases');

  metaSid.textContent = sid ?? '—';
  metaStatus.textContent = resultPayload?.result || resultPayload?.status || '—';
  metaPassed.textContent = String(!!resultPayload?.passed);
  metaCases.textContent = Array.isArray(resultPayload?.cases) ? resultPayload.cases.length : 0;
}

/* ---------- Load submission ---------- */
async function loadSubmission(){
  const sid = getSidFromQuery();
  if(!sid){
    statusText.textContent = '❌ Missing ?submissionID=';
    return;
  }
  statusText.textContent = 'Fetching submission…';
  const data = await pollForResult(sid);
  if(!data){ return; }
  renderMeta(sid, data);
  statusText.textContent = '';
  renderCases(data.cases || []);
}

/* ---------- Show Source Code (password input) ---------- */
async function fetchAndShowCode(){
  const sid = getSidFromQuery();
  if(!sid){ codeStatus.textContent = '❌ Missing submissionID.'; return; }

  const password = (codePwd.value || '').trim();
  if(!password){
    codeStatus.textContent = '⚠️ Please enter a password.'; 
    codePre.style.display='none';
    copyCodeBtn.disabled = true;
    return;
  }

  try {
    showCodeBtn.disabled = true;
    codeStatus.textContent = 'Loading code…';
    const url = `${URL}/getSubmissionCode/${encodeURIComponent(sid)}?password=${encodeURIComponent(password)}`;
    const res = await fetch(url, { headers: {'ngrok-skip-browser-warning':'true'} });
    if(!res.ok){
      const err = await res.json().catch(()=>({error:'Request failed'}));
      codeStatus.textContent = `❌ ${err.error || 'Failed to fetch code'}`;
      codePre.style.display='none';
      copyCodeBtn.disabled = true;
      return;
    }
    const data = await res.json();
    const code = data.code ?? '';

    codeBlock.textContent = code;
    codePre.style.display = 'block';
    codeStatus.textContent = `Showing code for sid ${data.sid}`;
    copyCodeBtn.disabled = !code;

    // Try to auto-highlight if hljs is present
    try {
      if (window.hljs) hljs.highlightElement(codeBlock);
    } catch {}

    // Cache password for this tab (optional)
    sessionStorage.setItem('iimoc_admin_pw', password);
  } catch (e){
    console.error(e);
    codeStatus.textContent = '❌ Could not load code.';
    codePre.style.display='none';
    copyCodeBtn.disabled = true;
  } finally {
    showCodeBtn.disabled = false;
  }
}

/* ---------- Copy code ---------- */
async function copyCodeToClipboard(){
  const text = codeBlock.textContent || '';
  try {
    await navigator.clipboard.writeText(text);
    const old = copyCodeBtn.textContent;
    copyCodeBtn.textContent = 'Copied!';
    setTimeout(()=>copyCodeBtn.textContent=old, 900);
  } catch {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  }
}

/* ---------- Wire up ---------- */
refreshBtn.addEventListener('click', loadSubmission);
showCodeBtn.addEventListener('click', fetchAndShowCode);
copyCodeBtn.addEventListener('click', copyCodeToClipboard);

// Prefill password from this tab session if present
const cached = sessionStorage.getItem('iimoc_admin_pw');
if (cached) codePwd.value = cached;

/* ---------- Kick off ---------- */
loadSubmission();
</script>
</body>
</html>
