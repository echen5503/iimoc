<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IIMOC Signup</title>

  <style>
    body { background:#181818; color:#f0f0f0; font-family:Consolas,'Courier New',monospace; margin:0; }
    header { width:100%; background:#181818; border-bottom:1px solid #333; }
    .nav { display:flex; align-items:center; justify-content:space-between; max-width:740px; margin:0 auto; padding:16px 20px 8px; }
    .nav-links { display:flex; gap:18px; }
    .nav-link, .btn {
      background:#282828; color:#f0f0f0; border:1px solid #444; border-radius:4px;
      padding:10px 20px; font-family:inherit; font-size:1.0rem; cursor:pointer;
      text-decoration:none; font-weight:600; letter-spacing:1px; transition:background .13s;
      display:inline-flex; align-items:center; gap:8px;
    }
    .nav-link:hover, .btn:hover { background:#333; }
    .nav-link.active { background:#333; cursor:default; }
    .brand-title { font-size:1.5rem; color:#fafafa; letter-spacing:2px; display:flex; align-items:center; gap:7px; text-decoration:none; }
    .brand-title svg { height:38px; width:38px; color:#b89bfa; stroke-width:2.2; }

    .container { max-width:740px; margin:56px auto 40px; padding:38px 32px; background:#222; border-radius:8px; border:1px solid #444; }
    h1 { text-align:center; font-size:2rem; margin-bottom:18px; }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input:not([type]) {
      background:#111;
      color:#fafafa;
      border:1px solid #444;
      border-radius:6px;
      padding:12px 14px;
      font-family:Consolas,'Courier New',monospace;
      font-size:1rem;
      transition:border-color .2s, box-shadow .2s;
      width:100%;
      box-sizing:border-box;
    }
    input:focus { outline:none; border-color:#735ac4; box-shadow:0 0 0 2px rgba(115,90,196,0.35); }
    input::placeholder { color:#888; opacity:0.7; }

    label { font-weight:700; letter-spacing:.5px; display:block; margin-bottom:4px; }
    .field { margin-bottom:16px; }
    .hint { font-size:0.9rem; color:#9ca3af; margin-top:4px; }

    .btn-lg { font-size:1.05rem; padding:12px 22px; margin-top:8px; }

    .status-panel {
      margin-top:20px;
      background:#1a1a1d;
      border:1px solid #34343a;
      border-radius:6px;
      padding:14px 16px;
      font-size:0.96rem;
      white-space:pre-line;
    }
    .status-panel.success { border-color:#16a34a; color:#bbf7d0; background:#052e16; }
    .status-panel.error   { border-color:#f97373; color:#fecaca; background:#450a0a; }
    .hidden { display:none; }

    /* Team members UI */
    .members {
      border:1px solid #34343a;
      background:#1a1a1d;
      border-radius:8px;
      padding:14px 14px 10px 14px;
      margin-bottom:16px;
    }
    .members-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .members-header .title {
      font-weight:800;
      letter-spacing:.6px;
    }
    .member-row {
      display:grid;
      grid-template-columns: 1.1fr 1.2fr auto;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .member-row:last-child { margin-bottom: 6px; }
    .btn-sm { padding:10px 12px; font-size:0.95rem; }
    .danger { border-color:#7f1d1d; background:#2a0f0f; }
    .danger:hover { background:#3a1414; }

    @media (max-width:900px){
      .container,.nav{ max-width:98vw; padding-left:5vw; padding-right:5vw; }
      .member-row { grid-template-columns: 1fr; }
      .member-row .btn { width: 100%; justify-content:center; }
    }
    a { color:cyan; }
  </style>
</head>

<body>
<header>
  <nav class="nav">
    <a href="/index.html" class="brand-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 4H6l7 8-7 8h12"/>
      </svg>
      <span><span>I</span><span>I</span><span>M</span><span>O</span><span>C</span></span>
    </a>
    <div class="nav-links">
      <a class="nav-link" href="/problem.html?pid=Permutation">Problem</a>
      <a class="nav-link" href="/sponsor.html">Sponsors</a>
      <a class="nav-link" href="/contact.html">Contact</a>
      <span class="nav-link active">Signup</span>
    </div>
  </nav>
</header>

<main>
  <section class="container">
    <h1>Team Signup</h1>
    <p class="hint" style="margin-bottom:18px;">
      Create your team credentials for the IIMOC judge. If your team already exists, enter the same password to update your team members.
    </p>

    <form id="signupForm">
      <div class="field">
        <label for="team">Team Name *</label>
        <input id="team" name="team" placeholder="e.g. Cascadian Coalition of Nerds" required />
        <div class="hint">This is the name you’ll use on the submission page and leaderboard.</div>
      </div>

      <div class="field">
        <label for="password">Team Password *</label>
        <input id="password" name="password" type="password" placeholder="choose a password" required />
        <div class="hint">
          Keep this secret within your team. You’ll need it each time you submit code.
        </div>
      </div>

      <div class="field">
        <label for="password2">Confirm Password *</label>
        <input id="password2" name="password2" type="password" placeholder="re-enter password" required />
      </div>

      <div class="field">
        <label for="school">School / Organization *</label>
        <input id="school" name="school" placeholder="e.g. Lincoln High School" required />
      </div>

      <div class="field">
        <label for="country">Country / Region *</label>
        <input id="country" name="country" placeholder="e.g. United States" required />
      </div>

      <div class="field">
        <label for="email">Contact Email *</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required />
        <div class="hint">Primary contact email for organizers to reach your team.</div>
      </div>

      <!-- Team members list -->
      <div class="members" id="membersBox">
        <div class="members-header">
          <div class="title">Team Members</div>
          <button type="button" class="btn btn-sm" id="addMemberBtn">+ Add member</button>
        </div>

        <div class="hint" style="margin:0 0 12px 0;">
          Add each team member's name and (optionally) email. The contact email above remains the primary contact.
        </div>

        <div id="membersList"></div>

        <div class="hint" style="margin-top:10px;">
          Minimum 1 member required.
        </div>
      </div>

      <p class="hint">
        If you forgot your team password, please contact
        <a href="mailto:edwin.chen@iimoc.org">edwin.chen@iimoc.org</a>.
      </p>

      <button type="submit" class="btn btn-lg" id="signupBtn">Create / Update Team</button>
    </form>

    <div id="statusBox" class="status-panel hidden"></div>
  </section>
</main>

<script>
  const URL = "https://diphycercal-aurore-introrsely.ngrok-free.dev";

  const form      = document.getElementById('signupForm');
  const statusBox = document.getElementById('statusBox');
  const signupBtn = document.getElementById('signupBtn');

  const membersList = document.getElementById('membersList');
  const addMemberBtn = document.getElementById('addMemberBtn');

  function setStatus(kind, msg) {
    statusBox.classList.remove('hidden', 'success', 'error');
    statusBox.classList.add(kind === 'success' ? 'success' : 'error');
    statusBox.textContent = msg;
  }

  function escId(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g, '_'); }

  function addMemberRow(init = {}) {
    const rowId = `m_${Math.random().toString(36).slice(2)}`;

    const row = document.createElement('div');
    row.className = 'member-row';
    row.dataset.rowId = rowId;

    // Note: using value attribute with basic escaping for quotes.
    row.innerHTML = `
      <div>
        <label for="${escId(rowId)}_name" style="margin:0 0 4px 0;">Name *</label>
        <input type="text" id="${escId(rowId)}_name" class="member-name" placeholder="Member name" value="${String(init.name||'').replace(/"/g,'&quot;')}" required />
      </div>
      <div>
        <label for="${escId(rowId)}_email" style="margin:0 0 4px 0;">Email (optional)</label>
        <input type="email" id="${escId(rowId)}_email" class="member-email" placeholder="member@example.com" value="${String(init.email||'').replace(/"/g,'&quot;')}" />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button type="button" class="btn btn-sm danger member-remove">Remove</button>
      </div>
    `;

    row.querySelector('.member-remove').addEventListener('click', () => {
      row.remove();
      enforceAtLeastOneMember();
    });

    membersList.appendChild(row);
    enforceAtLeastOneMember();
  }

  function enforceAtLeastOneMember(){
    const rows = Array.from(membersList.querySelectorAll('.member-row'));
    if (rows.length === 0) addMemberRow();

    const updatedRows = Array.from(membersList.querySelectorAll('.member-row'));
    const disableRemove = updatedRows.length <= 1;
    for (const r of updatedRows) {
      const btn = r.querySelector('.member-remove');
      if (btn) btn.disabled = disableRemove;
    }
  }

  function readMembers(){
    const rows = Array.from(membersList.querySelectorAll('.member-row'));
    const members = [];

    for (const r of rows){
      const nameEl = r.querySelector('.member-name');
      const emailEl = r.querySelector('.member-email');

      const name = (nameEl ? nameEl.value : '').trim();
      const email = (emailEl ? emailEl.value : '').trim();

      if (!name) continue;
      members.push(email ? { name, email } : { name });
    }
    return members;
  }

  addMemberBtn.addEventListener('click', () => addMemberRow());

  // Start with 1 member row by default
  addMemberRow();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const team      = document.getElementById('team').value.trim();
    const password  = document.getElementById('password').value;
    const password2 = document.getElementById('password2').value;
    const school    = document.getElementById('school').value.trim();
    const email     = document.getElementById('email').value.trim();
    const country   = document.getElementById('country').value.trim();

    const members = readMembers();

    if (!team || !password || !school || !email || !country) {
      setStatus('error', 'All fields are required.');
      return;
    }
    if (password !== password2) {
      setStatus('error', 'Passwords do not match.');
      return;
    }

    // Validate members: every row must have a name
    const memberRows = Array.from(membersList.querySelectorAll('.member-row'));
    for (const r of memberRows){
      const name = (r.querySelector('.member-name')?.value || '').trim();
      if (!name) {
        setStatus('error', 'Each team member must have a name.');
        return;
      }
    }
    if (members.length < 1) {
      setStatus('error', 'At least one team member is required.');
      return;
    }

    signupBtn.disabled = true;
    signupBtn.textContent = 'Submitting...';
    setStatus('success', 'Submitting request…');

    try {
      const payload = { team, password, school, email, country, members };

      const res = await fetch(`${URL}/signup`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'ngrok-skip-browser-warning': 'true'
        },
        body: JSON.stringify(payload)
      });

      let data = null;
      try { data = await res.json(); } catch { data = null; }

      if (!res.ok) {
        const msg =
          (data && (data.error || data.message)) ||
          `Request failed (HTTP ${res.status})`;

        // Special-case wrong password (backend uses 401)
        if (res.status === 401) {
          setStatus('error', `Team exists, but the password is incorrect.\n\nIf you forgot the password, contact edwin.chen@iimoc.org.`);
        } else {
          setStatus('error', msg);
        }
      } else {
        const serverMsg = (data && data.message) ? data.message : 'Success.';
        const createdOrUpdated =
          res.status === 201 ? 'Created' :
          res.status === 200 ? 'Updated' : 'Saved';

        setStatus('success',
`✅ ${createdOrUpdated}: ${serverMsg}
Team: ${team}
Members: ${members.map(m => m.name + (m.email ? ` <${m.email}>` : '')).join(', ')}

You can now go to the problem page and submit using this team name + password.`);
      }
    } catch (err) {
      console.error(err);
      setStatus('error', 'Network or server error during signup.');
    } finally {
      signupBtn.disabled = false;
      signupBtn.textContent = 'Create / Update Team';
    }
  });
</script>

</body>
</html>
