<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IIMOC Certificate</title>
<meta name="description" content="IIMOC Certificate" />

<style>
  body {
    background: #181818;
    color: #f0f0f0;
    font-family: Consolas, 'Courier New', monospace;
    margin: 0;
    padding: 0;
  }
  header {
    width: 100%;
    background: #181818;
    border-bottom: 1px solid #333;
  }
  .nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 940px;
    margin: 0 auto;
    padding: 16px 20px 8px 20px;
  }
  .brand-title {
    font-size: 1.5rem;
    color: #fafafa;
    letter-spacing: 2px;
    font-family: inherit;
    display: flex;
    align-items: center;
    gap: 7px;
    cursor: pointer;
    text-decoration: none;
  }
  .brand-title svg {
    vertical-align: middle;
    height: 38px;
    width: 38px;
    color: #b89bfa;
    stroke-width: 2.2;
    flex-shrink: 0;
  }
  #scrambleText {
    color: #fff;
    letter-spacing: 0.02em;
    font-weight: bold;
    font-size: 1.2em;
    display: flex;
    align-items: center;
  }
  .brand-title .scramble-char {
    display: inline-block;
    min-width: 1ch;
    transition: color 0.17s;
    color: inherit;
    font-family: inherit;
  }
  .nav-links {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .btn, .btn-lg, .nav-link {
    background: #282828;
    color: #f0f0f0;
    border: 1px solid #444;
    border-radius: 4px;
    padding: 10px 16px;
    font-family: inherit;
    font-size: 1.02rem;
    cursor: pointer;
    text-decoration: none;
    font-weight: 600;
    letter-spacing: 1px;
    transition: background .13s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    user-select: none;
  }
  .btn-lg { font-size: 1.08rem; padding: 14px 20px; }
  .btn:hover, .btn-lg:hover, .nav-link:hover { background: #333; }
  .nav-link.active { background: #333; cursor: default; }

  .wrap {
    max-width: 940px;
    margin: 34px auto 40px auto;
    padding: 0 20px;
    box-sizing: border-box;
  }

  .cert {
    background: #222;
    border-radius: 10px;
    border: 1px solid #444;
    box-sizing: border-box;
    padding: 32px 28px 24px 28px;
    position: relative;
    overflow: hidden;
  }
  .cert::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 10px;
    background: linear-gradient(90deg, #1f2933, #111827);
    border-bottom: 1px solid #333;
  }

  .cert-inner {
    margin-top: 12px;
    border: 1px solid #333;
    background: #19191c;
    border-radius: 8px;
    padding: 26px 22px 20px 22px;
  }

  .top-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 18px;
    flex-wrap: wrap;
  }

  .title {
    letter-spacing: 2px;
    color: #fafafa;
    margin: 0;
    font-weight: normal;
    font-size: 1.85rem;
  }

  .subtitle {
    margin-top: 8px;
    color: #d0d0d0;
    letter-spacing: 0.8px;
    line-height: 1.5;
    font-size: 1.04rem;
  }

  .award-pill {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border: 1px solid #444;
    border-radius: 999px;
    background: #181818;
    letter-spacing: 1px;
    font-weight: 700;
    white-space: nowrap;
  }

  .award-dot {
    height: 10px;
    width: 10px;
    border-radius: 50%;
    background: #b89bfa;
    box-shadow: 0 0 0 2px rgba(184,155,250,0.18);
  }

  .name-block {
    margin-top: 22px;
    text-align: center;
    padding: 18px 14px;
    border: 1px solid #333;
    border-radius: 8px;
    background: #181818;
  }

  .label {
    color: #bdbdbd;
    letter-spacing: 1px;
    font-size: 0.95rem;
    margin-bottom: 8px;
  }

  .recipient {
    margin: 0;
    color: #f0e7ff;
    font-size: 1.7rem;
    letter-spacing: 1.4px;
    font-weight: 700;
  }

  /* Member picker UI */
  .picker {
    margin-top: 12px;
    display: none;
    text-align: center;
  }
  .picker-row {
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
  }
  .picker select {
    min-width: min(520px, 92vw);
    justify-content: space-between;
  }
  .picker-hint {
    margin-top: 10px;
    color: #9aa0a6;
    font-size: 0.92rem;
    letter-spacing: 0.4px;
    line-height: 1.4;
  }
  .picker-error {
    margin-top: 10px;
    color: #fca5a5;
    font-size: 0.92rem;
    letter-spacing: 0.4px;
    line-height: 1.4;
  }

  .details {
    margin-top: 16px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .detail {
    border: 1px solid #333;
    border-radius: 8px;
    background: #181818;
    padding: 14px 14px 12px 14px;
  }
  .detail .k {
    color: #ababab;
    font-size: 0.92rem;
    letter-spacing: 0.9px;
    margin-bottom: 8px;
  }
  .detail .v {
    color: #dedede;
    font-size: 1.02rem;
    letter-spacing: 0.6px;
    line-height: 1.4;
    word-break: break-word;
  }

  .mid-text {
    margin-top: 18px;
    text-align: center;
    color: #cfcfcf;
    line-height: 1.6;
    font-size: 1.02rem;
  }

  .footer-row {
    margin-top: 20px;
    display: grid;
    grid-template-columns: 1fr 240px;
    gap: 14px;
    align-items: end;
  }

  .signatures {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .sig {
    border: 1px solid #333;
    border-radius: 8px;
    background: #181818;
    padding: 14px 14px 12px 14px;
    min-height: 86px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }

  /* Signature image area */
  .sig-img {
    height: 44px;
    width: 100%;
    object-fit: contain;
    display: block;
    margin: 0 auto 8px auto;
  }

  .sig-white {
    filter: invert(1) brightness(1.15) contrast(1.15);
  }

  .sig .line {
    border-top: 1px solid #444;
    margin-top: 10px;
    padding-top: 8px;
    color: #bdbdbd;
    font-size: 0.92rem;
    letter-spacing: 0.8px;
  }

  .qr {
    border: 1px solid #333;
    border-radius: 8px;
    background: #181818;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
    justify-content: center;
  }

  .qr-box {
    height: 140px;
    width: 140px;
    border: 1px dashed #444;
    border-radius: 8px;
    display: grid;
    place-items: center;
    color: #9aa0a6;
    font-size: 0.92rem;
    letter-spacing: 0.6px;
    text-align: center;
    padding: 10px;
    box-sizing: border-box;
    white-space: pre-line;
  }
  .qr-box img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .verify {
    color: #e5e7eb;
    font-size: 0.92rem;
    letter-spacing: 0.5px;
    text-align: center;
  }
  .verify a {
    color: inherit;
    text-decoration: underline;
  }

  .actions {
    margin-top: 16px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .note {
    margin-top: 14px;
    text-align: center;
    color: #888;
    font-size: 0.92rem;
    line-height: 1.5;
  }

  /* Medal variants: driven by placement -> percentile */
  .gold .award-dot { background: #D4AF37; box-shadow: 0 0 0 2px rgba(212,175,55,0.18); }
  .silver .award-dot { background: #C0C0C0; box-shadow: 0 0 0 2px rgba(192,192,192,0.18); }
  .bronze .award-dot { background: #CD7F32; box-shadow: 0 0 0 2px rgba(205,127,50,0.18); }

  .site-footer {
    margin-top: 26px;
    border-top: 1px solid #333;
    color: #888;
    text-align: center;
    padding: 18px 0 12px 0;
  }

  @media (max-width: 860px) {
    .details { grid-template-columns: 1fr; }
    .footer-row { grid-template-columns: 1fr; }
    .signatures { grid-template-columns: 1fr; }
  }

  @page { margin: 0; }

  @media print {
    /* Print only the certificate */
    header, .actions, .site-footer, .note { display: none !important; }

    /* IMPORTANT: hide picker in print/PDF */
    #memberPickerWrap { display: none !important; }

    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    body { margin: 0 !important; background: #181818 !important; }
    .wrap { margin: 0 !important; padding: 0 !important; max-width: none !important; }

    .cert {
      width: calc(100vw - 24px) !important;
      max-width: 940px !important;
      margin: 12px auto !important;
      padding: 18px 18px 14px 18px !important;
      border-radius: 10px !important;
    }

    .cert-inner {
      margin-top: 8px !important;
      padding: 16px 14px 12px 14px !important;
    }

    .top-row { gap: 10px !important; }
    .title { font-size: 1.55rem !important; }
    .subtitle { font-size: 0.95rem !important; margin-top: 6px !important; }

    .award-pill { padding: 8px 10px !important; font-size: 0.95rem !important; }

    .name-block { margin-top: 14px !important; padding: 12px 10px !important; }
    .label { font-size: 0.85rem !important; margin-bottom: 6px !important; }
    .recipient { font-size: 1.45rem !important; }

    .mid-text { margin-top: 12px !important; font-size: 0.95rem !important; }

    .details { margin-top: 10px !important; gap: 8px !important; }
    .detail { padding: 10px 10px 9px 10px !important; }
    .detail .k { font-size: 0.82rem !important; margin-bottom: 6px !important; }
    .detail .v { font-size: 0.92rem !important; }

    .footer-row { margin-top: 12px !important; gap: 10px !important; grid-template-columns: 1fr 200px !important; }
    .signatures { gap: 8px !important; }

    .sig { min-height: 72px !important; padding: 10px 10px 9px 10px !important; }
    .sig-img { height: 36px !important; margin-bottom: 6px !important; }
    .sig .line { margin-top: 8px !important; padding-top: 6px !important; font-size: 0.85rem !important; }

    .qr { padding: 10px !important; gap: 8px !important; }
    .qr-box { width: 120px !important; height: 120px !important; padding: 6px !important; }
    .verify { font-size: 0.85rem !important; }

    .cert, .cert-inner, .detail, .sig, .qr, .name-block {
      break-inside: avoid !important;
      page-break-inside: avoid !important;
    }
  }
</style>
</head>

<body>
<header>
  <nav class="nav">
    <a class="brand-title" id="brandTitle" href="index.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 4H6l7 8-7 8h12"/>
      </svg>
      <span id="scrambleText">
        <span class="scramble-char">I</span>
        <span class="scramble-char">I</span>
        <span class="scramble-char">M</span>
        <span class="scramble-char">O</span>
        <span class="scramble-char">C</span>
      </span>
    </a>
    <div class="nav-links">
      <a class="nav-link" href="rules.html">Rules</a>
      <a class="nav-link" href="contact.html">Contact</a>
      <a class="btn" href="/signup.html" target="_blank" rel="noopener noreferrer">Sign Up</a>
    </div>
  </nav>
</header>

<main class="wrap">
  <section class="cert" id="certRoot">
    <div class="cert-inner">
      <div class="top-row">
        <div>
          <h1 class="title">CERTIFICATE</h1>
          <div class="subtitle">
            International Invitational Math Optimization Challenge (IIMOC)<br />
            This document certifies the standing and distinction listed below.
            This result can be verified at <a id="verifyTopLink" href="/leaderboard.html" style="color: cyan">iimoc.org</a>.
          </div>
        </div>

        <div class="award-pill" id="awardPill" aria-label="Award level">
          <span class="award-dot" aria-hidden="true"></span>
          <span id="awardText">GOLD AWARD</span>
        </div>
      </div>

      <div class="name-block">
        <div class="label">THIS CERTIFICATE IS AWARDED TO</div>
        <p class="recipient" id="recipientName">Participant Name</p>

        <!-- Member picker -->
        <div class="picker" id="memberPickerWrap">
          <div class="label" style="margin-bottom:8px;">SELECT TEAM MEMBER</div>
          <div class="picker-row">
            <select id="memberPicker" class="btn" aria-label="Select team member">
              <option value="">Loading members…</option>
            </select>
            <a id="signupLinkInline" class="btn" href="/signup.html" style="display:none;">Go to Sign Up</a>
          </div>
          <div class="picker-hint" id="memberPickerHint" style="display:none;"></div>
          <div class="picker-error" id="memberPickerError" style="display:none;"></div>
        </div>
      </div>

      <div class="mid-text" id="midText">
        <span id="teamInline">Team Name</span> placed
        <strong><span id="placementRank">1</span> out of <span id="teamCount">237</span> teams</strong>
        (<strong><span id="placementPercentile">10</span>th percentile</strong>)
        and is awarded the <strong><span id="awardInline">GOLD</span></strong> distinction.
      </div>

      <div class="details">
        <div class="detail">
          <div class="k">TEAM / CLUB</div>
          <div class="v" id="teamName">Team Name</div>
        </div>
        <div class="detail">
          <div class="k">CATEGORY</div>
          <div class="v" id="category">Overall</div>
        </div>
        <div class="detail">
          <div class="k">DATE</div>
          <div class="v" id="awardDate">Dec 30, 2025</div>
        </div>
        <div class="detail">
          <div class="k">CERTIFICATE ID</div>
          <div class="v" id="certId">IIMOC-2025-XXXX</div>
        </div>
      </div>

      <div class="footer-row">
        <div class="signatures">
          <div class="sig">
            <img class="sig-img sig-white" src="assets/edwinchen.png" alt="Edwin Chen signature" />
            <div class="line">Edwin Chen — Contest Director</div>
          </div>
          <div class="sig">
            <img class="sig-img sig-white" src="assets/shangzhou.png" alt="Shang Zhou signature" />
            <div class="line">Shang Zhou — Contest Problemsetter</div>
          </div>
        </div>

        <div class="qr">
          <div class="qr-box" id="qrBox">
            <img id="qrImg" alt="Verification QR" />
          </div>
          <div class="verify">
            Verify: <a id="verifyLink" href="/leaderboard.html">iimoc.org</a>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-lg" type="button" onclick="window.print()">
        Print / Save PDF
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" style="height:22px;width:22px;">
          <path d="M6 9V2h12v7"></path>
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
          <path d="M6 14h12v8H6z"></path>
        </svg>
      </button>

      <a class="btn-lg" href="index.html">
        Back to IIMOC
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" style="height:22px;width:22px;">
          <path d="M19 12H5"></path>
          <path d="m12 19-7-7 7-7"></path>
        </svg>
      </a>
    </div>
  </section>

  <footer class="site-footer">
    <div>&copy; <span id="year"></span> IIMOC. All rights reserved.</div>
  </footer>
</main>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // Scramble effect (unchanged)
  (function() {
    const symbols = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#$%&?@*";
    const original = ["I", "I", "M", "O", "C"];
    const scrambleDuration = 350; // ms

    const scrambleText = document.getElementById('scrambleText');
    if (!scrambleText) return;

    const chars = Array.from(scrambleText.querySelectorAll('.scramble-char'));
    let running = false;

    function randomSymbol() {
      return symbols[Math.floor(Math.random() * symbols.length)];
    }
    function scrambleFrame(progress) {
      chars.forEach((span, i) => {
        if (progress < 0.8 || Math.random() > progress) {
          span.textContent = randomSymbol();
        } else {
          span.textContent = original[i];
        }
      });
    }
    function endScramble() {
      chars.forEach((span, i) => span.textContent = original[i]);
      running = false;
    }
    function startScramble() {
      if (running) return;
      running = true;
      const start = performance.now();
      function animate(now) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / scrambleDuration, 1);
        scrambleFrame(progress);
        if (elapsed < scrambleDuration) requestAnimationFrame(animate);
        else endScramble();
      }
      requestAnimationFrame(animate);
    }

    const brandTitle = document.getElementById('brandTitle');
    brandTitle.addEventListener('mouseenter', startScramble);
    brandTitle.addEventListener('focus', startScramble);
    brandTitle.addEventListener('mouseleave', endScramble);
    brandTitle.addEventListener('blur', endScramble);
  })();

  // Helpers
  function percentileFromPlacement(rank, total) {
    return (rank / total) * 100;
  }

  // Medal thresholds by percentile: Gold <= 10, Silver <= 20, Bronze <= 30
  function medalFromPercentile(p) {
    if (p === null || Number.isNaN(p)) return { tier: "PARTICIPANT", className: "" };
    if (p <= 10) return { tier: "GOLD", className: "gold" };
    if (p <= 20) return { tier: "SILVER", className: "silver" };
    if (p <= 30) return { tier: "BRONZE", className: "bronze" };
    return { tier: "PARTICIPANT", className: "" };
  }

  function normalizeTeamName(s){
    return String(s || "").trim();
  }

  function getTeamFromRow(row){
    if (!row) return "";
    if (row.team != null) return normalizeTeamName(row.team);
    if (row.metadata && row.metadata.team != null) return normalizeTeamName(row.metadata.team);
    return "";
  }

  function getScoreFromRow(row){
    const v = row && row.score != null ? Number(row.score) : 0;
    return Number.isFinite(v) ? v : 0;
  }

  function getTsFromRow(row){
    const metaTs = row && row.metadata && row.metadata.ts != null ? Number(row.metadata.ts) : NaN;
    const directTs = row && row.ts != null ? Number(row.ts) : NaN;
    const t = Number.isFinite(directTs) ? directTs : (Number.isFinite(metaTs) ? metaTs : NaN);
    return t;
  }

  function computeRankFromLeaderboard(payload, team){
    const teamNorm = normalizeTeamName(team).toLowerCase();
    if (!teamNorm) return { rank: null, totalTeams: 0 };

    const subs = Array.isArray(payload?.submissions) ? payload.submissions : [];
    if (!subs.length) return { rank: null, totalTeams: 0 };

    // Reduce to best per team (max score; tie-break newer ts)
    const bestByTeam = new Map();
    for (const row of subs){
      const t = getTeamFromRow(row);
      if (!t) continue;
      const key = t.toLowerCase();
      const score = getScoreFromRow(row);
      const ts = getTsFromRow(row);

      const prev = bestByTeam.get(key);
      if (!prev){
        bestByTeam.set(key, { team: t, score, ts });
      } else {
        if (score > prev.score) bestByTeam.set(key, { team: t, score, ts });
        else if (score === prev.score) {
          const prevTs = Number.isFinite(prev.ts) ? prev.ts : -Infinity;
          const rowTs = Number.isFinite(ts) ? ts : -Infinity;
          if (rowTs > prevTs) bestByTeam.set(key, { team: t, score, ts });
        }
      }
    }

    const teams = Array.from(bestByTeam.values());
    teams.sort((a,b) => (b.score - a.score) || a.team.localeCompare(b.team));

    const totalTeams = teams.length;
    const idx = teams.findIndex(x => x.team.toLowerCase() === teamNorm);
    const rank = idx >= 0 ? (idx + 1) : null;

    return { rank, totalTeams };
  }

  async function fetchLeaderboardJson(pid){
    const url = `assets/${encodeURIComponent(pid)}/results/leaderboard.json`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Could not load leaderboard.json (HTTP ${res.status})`);
    return await res.json();
  }

  // --- Member picker helpers (more user-friendly) ---
  function setQueryParam(key, value) {
    const url = new URL(window.location.href);
    if (value == null || String(value).trim() === "") url.searchParams.delete(key);
    else url.searchParams.set(key, value);
    history.replaceState({}, "", url.toString());
  }

  function normalizeNameKey(s) {
    return String(s || "").trim().toLowerCase();
  }

  async function fetchTeamMembers(team) {
    const url = `https://contest.iimoc.org/team/${encodeURIComponent(team)}/members`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) {
      // surface common status codes with useful messaging
      const msg = (res.status === 401 || res.status === 403)
        ? "Could not load team members: invalid team or password."
        : `Could not load team members (HTTP ${res.status}).`;
      throw new Error(msg);
    }
    const payload = await res.json();
    return Array.isArray(payload?.members) ? payload.members : [];
  }

  function showMemberPicker() {
    const wrap = document.getElementById("memberPickerWrap");
    if (wrap) wrap.style.display = "block";
  }

  function setPickerState({ loading=false, error="", hint="", showSignup=false }) {
    const sel = document.getElementById("memberPicker");
    const hintEl = document.getElementById("memberPickerHint");
    const errEl = document.getElementById("memberPickerError");
    const signupBtn = document.getElementById("signupLinkInline");

    if (sel) sel.disabled = Boolean(loading);

    if (hintEl) {
      hintEl.style.display = hint ? "block" : "none";
      hintEl.textContent = hint || "";
    }
    if (errEl) {
      errEl.style.display = error ? "block" : "none";
      errEl.textContent = error || "";
    }
    if (signupBtn) {
      signupBtn.style.display = showSignup ? "inline-flex" : "none";
    }
  }

  function populateMemberPicker(members, currentName) {
    const sel = document.getElementById("memberPicker");
    if (!sel) return;

    sel.innerHTML = "";

    const opts = members
      .map(m => ({
        name: String(m?.name || "").trim(),
        email: String(m?.email || "").trim()
      }))
      .filter(m => m.name.length > 0);

    if (!opts.length) {
      // explicit empty roster case
      sel.innerHTML = `<option value="">No members found</option>`;
      setPickerState({
        loading: false,
        error: "",
        hint: "No team members are registered for this team. Please add members on the Sign Up page, then refresh this certificate.",
        showSignup: true
      });
      sel.disabled = true;
      return;
    }

    opts.sort((a, b) => a.name.localeCompare(b.name));

    // placeholder
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = "Select a team member…";
    sel.appendChild(ph);

    for (const m of opts) {
      const o = document.createElement("option");
      o.value = m.name;
      o.textContent = m.email ? `${m.name} (${m.email})` : m.name;
      sel.appendChild(o);
    }

    // preselect if currentName matches
    const curKey = normalizeNameKey(currentName);
    const match = opts.find(m => normalizeNameKey(m.name) === curKey);
    if (match) sel.value = match.name;

    // if nothing selected yet and we have a match, set; else leave placeholder
    if (!sel.value && opts.length) sel.value = match ? match.name : "";

    setPickerState({
      loading: false,
      error: "",
      hint: "Pick which teammate this certificate is for. This only changes the recipient name.",
      showSignup: false
    });

    sel.disabled = false;

    // Ensure we only bind once
    if (!sel.dataset.bound) {
      sel.addEventListener("change", () => {
        const chosen = String(sel.value || "").trim();
        if (!chosen) return;
        document.getElementById("recipientName").textContent = chosen;
        setQueryParam("name", chosen);
      });
      sel.dataset.bound = "1";
    }
  }
  // --- end member picker helpers ---

  // Populate from query string (pid drives QR + verify + leaderboard JSON)
  (async function populateCertificate() {
    const params = new URLSearchParams(window.location.search);

    const pid = (params.get("pid") || "polypacksys").trim();
    const team = params.get("team") || "Team Name";
    const name = params.get("name") || "Participant Name";
    const date = params.get("date") || "Dec 30, 2025";
    const category = params.get("category") || "Overall";

    const cert = params.get("cert") || (
      `IIMOC-2025-${team.toLowerCase().replace(/\s+/g, '-')}-${category}-${pid}`.toUpperCase()
    );

    // Inject static values first
    document.getElementById("recipientName").textContent = name;
    document.getElementById("teamName").textContent = team;
    document.getElementById("teamInline").textContent = team;
    document.getElementById("certId").textContent = cert;
    document.getElementById("awardDate").textContent = date;
    document.getElementById("category").textContent = category;

    // Member picker: show only when team+password present
    if (team && team !== "Team Name") {
      showMemberPicker();
      setPickerState({
        loading: true,
        error: "",
        hint: "Loading your team members…",
        showSignup: false
      });

      try {
        const members = await fetchTeamMembers(team);

        // If no explicit name, default to first member (but still let them change)
        if ((!params.get("name") || !String(params.get("name")).trim()) && members.length) {
          const first = String(members[0]?.name || "").trim();
          if (first) {
            document.getElementById("recipientName").textContent = first;
            setQueryParam("name", first);
          }
        }

        const currentRecipient = document.getElementById("recipientName").textContent;
        populateMemberPicker(members, currentRecipient);
      } catch (e) {
        const sel = document.getElementById("memberPicker");
        if (sel) sel.innerHTML = `<option value="">Unable to load members</option>`;
        setPickerState({
          loading: false,
          error: e.message || "Unable to load team members.",
          hint: "If you have not registered your members yet, add them on the Sign Up page and refresh.",
          showSignup: true
        });
      }
    } else if (team && team !== "Team Name" && !password) {
      // team present but no password: show message (still keep picker hidden to avoid confusion)
      // If you WANT to show it anyway, call showMemberPicker() here and display an error.
      // For now: do nothing.
    }

    // Wire verify links using pid
    const verifyHref = `/leaderboard.html?pid=${encodeURIComponent(pid)}`;
    const verifyTopLink = document.getElementById("verifyTopLink");
    const verifyLink = document.getElementById("verifyLink");
    if (verifyTopLink) verifyTopLink.href = verifyHref;
    if (verifyLink) verifyLink.href = verifyHref;

    // Wire QR image using pid
    const qrImg = document.getElementById("qrImg");
    if (qrImg) {
      qrImg.src = `assets/${encodeURIComponent(pid)}/results/QR.png`;
      qrImg.onerror = () => {
        const qrBox = document.getElementById("qrBox");
        if (qrBox) qrBox.textContent = "QR Code unavailable";
      };
    }

    // Defaults while loading / if JSON fails
    const placementRankEl = document.getElementById("placementRank");
    const teamCountEl = document.getElementById("teamCount");
    const placementPercentileEl = document.getElementById("placementPercentile");

    placementRankEl.textContent = "—";
    teamCountEl.textContent = "—";
    placementPercentileEl.textContent = "—";

    const awardTextEl = document.getElementById("awardText");
    const awardInlineEl = document.getElementById("awardInline");
    awardTextEl.textContent = "CERTIFICATE";
    awardInlineEl.textContent = "RECOGNITION";

    const root = document.getElementById("certRoot");
    root.classList.remove("gold", "silver", "bronze");

    if (!team || team === "Team Name") return;

    try {
      const leaderboardPayload = await fetchLeaderboardJson(pid);
      const { rank, totalTeams } = computeRankFromLeaderboard(leaderboardPayload, team);

      teamCountEl.textContent = totalTeams ? String(totalTeams) : "—";

      let percentile = null;
      if (typeof rank === "number" && totalTeams > 0) {
        placementRankEl.textContent = String(rank);
        percentile = percentileFromPlacement(rank, totalTeams);
        placementPercentileEl.textContent = String(Math.round(percentile * 10) / 10);
      } else {
        placementRankEl.textContent = "—";
        placementPercentileEl.textContent = "—";
      }

      const medal = medalFromPercentile(percentile);

      root.classList.remove("gold", "silver", "bronze");
      if (medal.className) root.classList.add(medal.className);

      if (medal.tier === "PARTICIPANT") {
        awardTextEl.textContent = "CERTIFICATE";
        awardInlineEl.textContent = "RECOGNITION";
      } else {
        awardTextEl.textContent = `${medal.tier} AWARD`;
        awardInlineEl.textContent = medal.tier;
      }
    } catch (e) {
      console.warn("Leaderboard JSON failed:", e);
    }
  })();
</script>

</body>
</html>
