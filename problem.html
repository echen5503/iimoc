<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IIMOC Problem</title>

  <style>
    /* ---------- Input Styling ---------- */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="password"],
    input:not([type]) {
      background:#111;
      color:#fafafa;
      border:1px solid #444;
      border-radius:6px;
      padding:12px 14px;
      font-family:Consolas,'Courier New',monospace;
      font-size:1rem;
      transition:border-color .2s, box-shadow .2s;
      width:100%;
      box-sizing:border-box;
    }
    input:focus { outline:none; border-color:#735ac4; box-shadow:0 0 0 2px rgba(115,90,196,0.35); }
    input::placeholder { color:#888; opacity:0.7; }
    input:disabled { background:#1a1a1a; color:#777; border-color:#333; cursor:not-allowed; }

    body { background:#181818; color:#f0f0f0; font-family:Consolas,'Courier New',monospace; margin:0; }
    header { width:100%; background:#181818; border-bottom:1px solid #333; }
    .nav { display:flex; align-items:center; justify-content:space-between; max-width:740px; margin:0 auto; padding:16px 20px 8px; }
    .nav-links { display:flex; gap:18px; }
    .nav-link, .btn {
      background:#282828; color:#f0f0f0; border:1px solid #444; border-radius:4px;
      padding:10px 20px; font-family:inherit; font-size:1.09rem; cursor:pointer;
      text-decoration:none; font-weight:600; letter-spacing:1px; transition:background .13s;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn-lg { font-size:1.13rem; padding:14px 26px; margin-top:14px; }
    .nav-link:hover, .btn:hover { background:#333; }
    .nav-link.active { background:#333; cursor:default; }
    .brand-title { font-size:1.5rem; color:#fafafa; letter-spacing:2px; display:flex; align-items:center; gap:7px; text-decoration:none; }
    .brand-title svg { height:38px; width:38px; color:#b89bfa; stroke-width:2.2; }
    .container { max-width:740px; margin:56px auto 40px; padding:38px 32px; background:#222; border-radius:8px; border:1px solid #444; }
    h1 { text-align:center; font-size:2.1rem; margin-bottom:18px; }
    .problem-text { background:#1b1b1e; border:1px solid #333; border-radius:6px; padding:22px 24px; margin-bottom:28px; line-height:1.6; color:#e0e0e0; font-size:1.04rem; }
    pre { background:#111; border:1px solid #333; border-radius:6px; padding:18px; overflow-x:auto; font-size:1rem; }
    .code-form { display:flex; flex-direction:column; gap:14px; }
    label { font-weight:700; letter-spacing:.5px; }
    textarea { min-height:220px; background:#111; color:#fafafa; border:1px solid #444; border-radius:6px; padding:16px; font-family:Consolas,'Courier New',monospace; font-size:1rem; resize:vertical; }
    textarea:focus { outline:2px solid #735ac4; }
    .status-panel { margin-top:28px; background:#1a1a1d; border:1px solid #34343a; border-radius:6px; padding:18px 20px; }
    .cases-table { width:100%; border-collapse:collapse; margin-top:12px; }
    .cases-table th, .cases-table td { border:1px solid #34343a; padding:10px 12px; text-align:left; font-size:0.98rem; }
    .cases-table th { background:#26262b; color:#f5f5f5; letter-spacing:1px; }
    .cases-table tr:nth-child(even) { background:#202024; }
    .case-status-ok { color:#8adf8a; font-weight:600; }
    .case-status-fail { color:#ff8a80; font-weight:600; }
    .hidden { display:none; }
    a {color:cyan;}
    @media (max-width:900px){ .container,.nav{ max-width:98vw; padding-left:5vw; padding-right:5vw; } .cases-table{ display:block; overflow-x:auto; } }
    code.language-python { background-color: #111!important; padding: 0!important; }

    .control-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    select.select {
      appearance:none; background:#111; color:#fafafa; border:1px solid #444; border-radius:6px;
      padding:10px 12px; font-family:inherit; font-size:1rem; cursor:pointer;
    }
    #statusText { white-space: pre-line; }

    /* Leaderboard header emphasis */
    #leaderboardPanel h2 { font-weight: 800; }
  </style>

  <!-- MathJax (configured to process inside pre/code) -->
  <script>
  window.MathJax = {
    options: { skipHtmlTags: ["script","noscript","style","textarea"] },
    tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']], processEscapes: true },
    svg: { fontCache: 'global' }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

  <!-- highlight.js (browser build) + theme -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/xt256.min.css">
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>

  <!-- marked + DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.5.7/dist/purify.min.js"></script>
</head>

<body>
<header>
  <nav class="nav">
    <a href="/index.html" class="brand-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 4H6l7 8-7 8h12"/></svg>
      <span id="scrambleText"><span>I</span><span>I</span><span>M</span><span>O</span><span>C</span></span>
    </a>
    <div class="nav-links">
      <a class="nav-link" href="/sponsor.html">Sponsors</a>
      <a class="nav-link" href="/team.html">Our Team</a>
      <a class="nav-link" href="/contact.html">Contact</a>
      <span class="nav-link active">Problem</span>
    </div>
  </nav>
</header>

<main>
  <section class="container">
    <div id="problemMarkdown" class="problem-text">Loading problem statement…</div>
    
    <form class="code-form" id="codeForm">
      <div class="control-row">
        <label for="langSelect">Language</label>
        <select id="langSelect" class="select" name="lang" required>
          <option value="python" selected>Python</option>
          <option value="cpp">C++</option>
          <option value="java">Java</option>
        </select>
      </div>
      <label for="team">Team Name</label>
      <input name="team" placeholder="your team">
      <label for="codeInput" id="codeLabel">Submit your solution</label>
      <textarea id="codeInput" name="code" placeholder="print('hello')" required></textarea>
      <button type="submit" class="btn btn-lg" id="submitBtn">Submit Solution</button>
    </form>

    <div class="status-panel hidden" id="statusPanel">
      <p class="status-text" id="statusText">Waiting for submission...</p>
      <div id="casesContainer"></div>
    </div>

    <!-- Leaderboard -->
    <section class="status-panel" id="leaderboardPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;font-size:1.25rem;letter-spacing:.5px;">Leaderboard</h2>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">

          <label for="lbPageSize" style="font-weight:700;">Page size</label>
          <select id="lbPageSize" class="select" style="width:auto;">
            <option>20</option>
            <option>50</option>
            <option selected>100</option>
          </select>
          <button type="button" class="btn" id="lbPrevBtn">Prev</button>
          <span id="lbPageInfo" style="min-width:180px;text-align:center;">—</span>
          <button type="button" class="btn" id="lbNextBtn">Next</button>
          <button type="button" class="btn" id="refreshLeaderboardBtn">Refresh</button>
        </div>
      </div>
      <div id="leaderboardContainer" style="margin-top:12px;"></div>
    </section>
  </section>
</main>

<script>
/* ---------- Config & helpers ---------- */
const URL = "https://diphycercal-aurore-introrsely.ngrok-free.dev";

function getPidFromQuery(){
  const p = new URLSearchParams(location.search);
  return "Permutation";
  //if(p.get('pid') == "polypack" || p.get('pid') == 'polypackmatrix') 
  return (p.get('pid') || '').trim();
}

/* ---------- Judging logic (send selected lang) ---------- */
const form = document.getElementById('codeForm');
const codeInput = document.getElementById('codeInput');
const submitBtn = document.getElementById('submitBtn');
const statusPanel = document.getElementById('statusPanel');
const statusText = document.getElementById('statusText');
const casesContainer = document.getElementById('casesContainer');
const langSelect = document.getElementById('langSelect');
const codeLabel = document.getElementById('codeLabel');

const leaderboardContainer = document.getElementById('leaderboardContainer');
const refreshLeaderboardBtn = document.getElementById('refreshLeaderboardBtn');

const TEMPLATES = {
  python: "print('hello')\n",
  cpp:
`#include <bits/stdc++.h>
using namespace std;
int main(){
  ios::sync_with_stdio(false);
  cin.tie(nullptr);
  cout << "hello\\n";
  return 0;
}
`,
  java:
`import java.io.*;
public class Main {
  public static void main(String[] args) throws Exception {
    System.out.println("hello");
  }
}
`
};

function applyTemplateFor(lang){
  codeInput.placeholder = TEMPLATES[lang] || '';
}
applyTemplateFor(langSelect.value);
langSelect.addEventListener('change', () => {
  applyTemplateFor(langSelect.value);
});

async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function formatTime(ns){ return (typeof ns==='number'&&Number.isFinite(ns))?(ns/1e6).toFixed(2)+' ms':'—'; }
function formatMemory(b){ return (typeof b==='number'&&Number.isFinite(b))?(b/1024).toFixed(0)+' KB':'—'; }

function renderCases(cases){
  if(!Array.isArray(cases)||cases.length===0){ casesContainer.innerHTML='<p>No cases available.</p>'; return; }
  const rows=cases.map((t,i)=>{
    const s=t.ok?'case-status-ok':'case-status-fail';
    const msg=(t.msg||'').replace(/\n/g,'<br />');
    return `<tr><td>Case ${i+1}</td><td class="${s}">${t.status||(t.ok?'Accepted':'Failed')}</td><td>${formatTime(t.time)}</td><td>${formatMemory(t.memory)}</td><td>${msg}</td></tr>`;
  }).join('');
  casesContainer.innerHTML=`<table class="cases-table"><thead><tr><th>Case</th><th>Status</th><th>Time</th><th>Memory</th><th>Message</th></tr></thead><tbody>${rows}</tbody></table>`;

  for (let idx=0; idx<cases.length; idx++) {
    const test = cases[idx];
    let msg = (test.msg || '');
    const row = casesContainer.querySelector(`tbody tr:nth-child(${idx + 1})`);
    if (idx === 0) {
      casesContainer._scoreTotal = 0;
      casesContainer._anyFail = false;
      const prev = document.getElementById('totalScoreBadge');
      if (prev) prev.remove();
    }
    if (!test.ok) casesContainer._anyFail = true;

    const match = msg.match(/-?\d[\d,]*(?:\.\d+)?/);
    if (match) {
      const value = Number(match[0].replace(/,/g, ''));
      test.extractedNumber = value;
      casesContainer._scoreTotal = (casesContainer._scoreTotal || 0) + value;

      if (row) {
        const cell = row.cells[4];
        if (cell) {
          const badge = document.createElement('span');
          badge.style.marginLeft = '10px';
          badge.style.color = '#9ee6ff';
          badge.style.fontWeight = '700';
          badge.textContent = `Extracted: ${value}`;
          cell.appendChild(badge);
        }
      }
    }
    if (idx === cases.length - 1) {
      const finalScore = casesContainer._anyFail ? 0 : (casesContainer._scoreTotal || 0);
      const totalEl = document.createElement('div');
      totalEl.id = 'totalScoreBadge';
      totalEl.style.marginTop = '12px';
      totalEl.style.padding = '10px 14px';
      totalEl.style.background = '#0b2a2f';
      totalEl.style.color = '#9ee6ff';
      totalEl.style.fontWeight = '700';
      totalEl.style.border = '1px solid #07494f';
      totalEl.style.display = 'inline-block';
      totalEl.textContent = `Total Score: ${finalScore}`;
      statusPanel.prepend(totalEl);
    }
  }
}

async function pollForResult(sid){
  let attempt=0;
  while(true){
    attempt++;
    try{
      const r=await fetch(`${URL}/result/${encodeURIComponent(sid)}`,{headers:{'ngrok-skip-browser-warning':'true'}});
      if(!r.ok) throw new Error('Result request failed');
      const payload=await r.json();
      if(payload&&payload.status==='done') return payload;
      if(payload&&payload.status==='error') {
        statusText.textContent=payload['error'];
        return;
      }
      statusText.textContent=`In queue (attempt ${attempt})...`;
    }catch(e){ console.error(e); statusText.textContent='Judging...'; }
    await sleep(1000);
  }
}

/* ---------- Leaderboard logic (paginated) ---------- */
const lbPageInfo = document.getElementById('lbPageInfo');
const lbPrevBtn = document.getElementById('lbPrevBtn');
const lbNextBtn = document.getElementById('lbNextBtn');
const lbPageSizeSel = document.getElementById('lbPageSize');

const lbState = {
  page: 1,
  pageSize: Number(lbPageSizeSel ? lbPageSizeSel.value : 100) || 100,
  totalPages: 1,
  pid: null,
};

function fmtTs(ts){
  try{
    if(!Number.isFinite(ts)) return '—';
    const d = new Date(ts);
    return d.toLocaleString(undefined, {hour12:false});
  }catch{ return '—'; }
}

function renderLeaderboardPayload(payload){
  if(!payload){
    leaderboardContainer.innerHTML = '<p>⚠️ No data.</p>';
    lbPageInfo.textContent = '—';
    return;
  }

  const { submissions=[], total=0, page=1, pageSize=lbState.pageSize, totalPages=1 } = payload;

  const rows = submissions.map((s, i)=>{
    const teamRaw = (s.metadata && s.metadata.team) ? s.metadata.team : '—';
    const teamHtml = teamRaw !== '—'
      ? `<a href="/teams.html?team=${encodeURIComponent(teamRaw)}">${teamRaw}</a>`
      : '—';
    const score = (typeof s.score === 'number') ? s.score : Number(s.score||0);
    const sid = s.sid ?? (s.metadata && s.metadata.sid) ?? '—';
    const when = (s.metadata && s.metadata.ts) ? fmtTs(Number(s.metadata.ts)) : '—';
    const sidHtml = sid !== '—'
      ? `<a href="/render.html?submissionID=${encodeURIComponent(sid)}">${sid}</a>`
      : '—';
    const rank = (page-1)*pageSize + (i+1);

    return `<tr>
      <td>${rank}</td>
      <td>${teamHtml}</td>
      <td>${score}</td>
      <td>${sidHtml}</td>
      <td>${when}</td>
    </tr>`;
  }).join('');

  leaderboardContainer.innerHTML = submissions.length === 0
    ? '<p>No submissions yet.</p>'
    : `
      <table class="cases-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Team</th>
            <th>Score</th>
            <th>Submission ID</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;

  lbState.totalPages = Math.max(1, Number(totalPages)||1);
  lbState.page = Math.max(1, Math.min(page, lbState.totalPages));
  lbPageInfo.textContent = `Page ${lbState.page} / ${lbState.totalPages} • Total ${total}`;
  lbPrevBtn.disabled = lbState.page <= 1;
  lbNextBtn.disabled = lbState.page >= lbState.totalPages;
}

async function loadLeaderboard(page = lbState.page){
  try{
    leaderboardContainer.innerHTML = '<p>Leaderboard Loading...</p>';
    const pid = getPidFromQuery();
    lbState.pid = pid;
    if(!pid){ leaderboardContainer.innerHTML = '<p>⚠️ Missing ?pid= in URL.</p>'; lbPageInfo.textContent='—'; return; }

    // NEW API: /getProblemSubmissions/:pid/:page?pageSize=...
    const url = `${URL}/getProblemSubmissions/${encodeURIComponent(pid)}/${encodeURIComponent(page)}?pageSize=${encodeURIComponent(lbState.pageSize)}`;
    const res = await fetch(url, { headers: {'ngrok-skip-browser-warning':'true'} });
    if(!res.ok) throw new Error('Failed to fetch leaderboard');
    const data = await res.json();
    renderLeaderboardPayload(data);
  }catch(e){
    console.error(e);
    leaderboardContainer.innerHTML = '<p>⚠️ Could not load leaderboard.</p>';
    lbPageInfo.textContent = '—';
  }
}

/* wire up */
if (refreshLeaderboardBtn){
  refreshLeaderboardBtn.addEventListener('click', ()=> loadLeaderboard(1));
}
if (lbPrevBtn){
  lbPrevBtn.addEventListener('click', ()=>{
    if (lbState.page > 1) loadLeaderboard(lbState.page - 1);
  });
}
if (lbNextBtn){
  lbNextBtn.addEventListener('click', ()=>{
    if (lbState.page < lbState.totalPages) loadLeaderboard(lbState.page + 1);
  });
}
if (lbPageSizeSel){
  lbPageSizeSel.addEventListener('change', ()=>{
    lbState.pageSize = Math.max(1, Number(lbPageSizeSel.value) || 20);
    loadLeaderboard(1);
  });
}

/* ---------- Submission handler ---------- */
form.addEventListener('submit',async e=>{
  e.preventDefault();
  const code=codeInput.value.trim();
  const team = document.querySelector('input[name="team"]').value.trim();
  const lang=langSelect.value;
  const pid = getPidFromQuery();
  if(!pid){
    statusPanel.classList.remove('hidden');
    statusText.textContent='Missing ?pid= in URL.';
    return;
  }
  if(!code){
    statusPanel.classList.remove('hidden');
    statusText.textContent='Please enter some code before submitting.';
    return;
  }
  submitBtn.disabled=true; submitBtn.textContent='Submitting...';
  statusPanel.classList.remove('hidden'); statusText.textContent='Submitting your solution...'; casesContainer.innerHTML='';
  try{
    const payload={pid,lang,code,team};
    const send=async(body,ct)=>{
      const opt={method:'POST',body,headers:{'ngrok-skip-browser-warning':'true'}};
      if(ct) opt.headers['Content-Type']=ct;
      const r=await fetch(`${URL}/submit`,opt);
      if(!r.ok) throw new Error('Submission failed');
      return r.json();
    };
    let sub;
    try{ sub=await send(JSON.stringify(payload),'application/json'); }
    catch{ sub=await send(JSON.stringify(payload),'text/plain;charset=UTF-8'); }

    const {sid}=sub||{};
    if(!sid) throw new Error('Judge did not return a submission id.');
    statusText.textContent='Submission received. Fetching results...';

    const result=await pollForResult(sid);
    if(result==undefined) return;
    statusText.textContent=''; renderCases(result.cases);

    // Refresh leaderboard after this submission; go back to page 1
    loadLeaderboard(1);
  }catch(e){
    console.error(e);
    statusText.textContent='Error: '+(e.message||'Unknown error');
  } finally {
    submitBtn.disabled=false; submitBtn.textContent='Submit Solution';
  }
});
</script>

<!-- ---------- Markdown + MathJax + HLJS rendering ---------- -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const container = document.getElementById('problemMarkdown');

  marked.setOptions({
    highlight: function(code, lang) {
      try {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang, ignoreIllegals: true }).value;
        }
        return hljs.highlightAuto(code).value;
      } catch {
        const div = document.createElement('div');
        div.textContent = code;
        return div.innerHTML;
      }
    }
  });

  try {
    const pid = (new URLSearchParams(location.search)).get('pid');
    if(!pid){ container.textContent = '⚠️ Missing ?pid= in URL.'; }
    else {
      const res = await fetch(`${URL}/problem/${encodeURIComponent(pid)}/statement`, {headers:{'ngrok-skip-browser-warning':'true'}});
      if (!res.ok) throw new Error(`Markdown not found (${res.status})`);
      const md = await res.text();

      const rawHtml = marked.parse(md);
      const safeHtml = DOMPurify.sanitize(rawHtml, { ADD_ATTR: ['class'] });
      container.innerHTML = safeHtml;

      container.querySelectorAll('pre code').forEach(block => {
        if (!block.classList.contains('hljs')) hljs.highlightElement(block);
      });

      if (window.MathJax && MathJax.typesetPromise) {
        await MathJax.typesetPromise([container]);
      }
    }
  } catch (err) {
    console.error(err);
    container.textContent = '⚠️ Could not load problem statement.';
  }

  // Initial leaderboard load
  loadLeaderboard(1);
});
</script>

</body>
</html>
